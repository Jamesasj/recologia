### 14.3. Offsets


### 14.3.2. Data generation
n.site <- 10
A <- runif(n = 2*n.site, 2,5)		# Areas range in size from 2 to 5 km2
x <- gl(n = 2, k = n.site, labels = c("grassland", "arable"))
linear.predictor <- log(A) + 0.69 +(0.92*(as.numeric(x)-1))
lambda <- exp(linear.predictor)
C <- rpois(n = 2*n.site, lambda = lambda) # Add Poisson noise


### 14.3.3. Analysis using R
glm.fit.no.offset <- glm(C ~ x, family = poisson)
glm.fit.with.offset <- glm(C ~ x, family = poisson, offset = log(A))
summary(glm.fit.no.offset)
summary(glm.fit.with.offset)
anova(glm.fit.with.offset, test = "Chisq") # LRT


### 14.3.4. Analysis using WinBUGS
# Define model
sink("Offset.txt")
cat("
model {
# Priors
 alpha ~ dnorm(0,0.001)
 beta ~ dnorm(0,0.001)

# Likelihood
 for (i in 1:n) {
    C[i] ~ dpois(lambda[i]) 
    log(lambda[i]) <- 1 * logA[i] + alpha + beta *x[i]	# Note offset
 }
}
",fill=TRUE)
sink()

# Bundle data
win.data <- list(C = C, x = as.numeric(x)-1, logA = log(A), n = length(x))

# Inits function
inits <- function(){ list(alpha=rlnorm(1), beta=rlnorm(1))}

# Parameters to estimate
params <- c("lambda","alpha", "beta")

# MCMC settings
nc <- 3		# Number of chains
ni <- 1100		# Number of draws from posterior
nb <- 100		# Number of draws to discard as burn-in
nt <- 2		# Thinning rate

# Start Gibbs sampling
out <- bugs(data=win.data, inits=inits, parameters.to.save=params, model.file="Offset.txt", 
n.thin=nt,n.chains=nc,n.burnin=nb, n.iter=ni, debug = TRUE)

print(out, dig = 3)
