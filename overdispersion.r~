### Gerando os dados
set.seed(123)
n.locais <- 20
x <- gl(n = 2, k = n.locais, labels = c("Nativo", "Arado"))
eps <- rnorm(2*n.locais, mean = 0, sd = 0.5)
lambda.OD <- exp(0.60 +(0.35*(as.numeric(x)-1) + eps) )

C.OD <- rpois(n = 2*n.locais, lambda = lambda.OD)

data.frame(Local=x,Contagem=C.OD)

boxplot(C.OD ~ x, col = "grey", xlab = "Uso da terra",
ylab = "Contagem de coelhos", las = 1, ylim = c(0, max(C.OD)))

### 14.1.3. Analysis using R
glm.fit.no.OD <- glm(C.OD ~ x, family = poisson)
glm.fit.with.OD <- glm(C.OD ~ x, family = quasipoisson)
summary(glm.fit.no.OD)
summary(glm.fit.with.OD)

anova(glm.fit.with.OD, test = "F")
anova(glm.fit.no.OD, test = "Chisq")

?glm

str(summary(glm.fit.with.OD))

glm.fit.with.OD$effects

glm.fit.no.OD$coefficients[1]
histograma<-hist(C.OD[as.numeric(x)==1],freq=F)
lines(density(C.OD[as.numeric(x)==1]),lty=3,lwd=2)
lines(dpois(histograma$breaks, glm.fit.no.OD$coefficients[1], log = F),col="red",lty=2,lwd=2)
lines(dpois(histograma$breaks, glm.fit.with.OD$coefficients[1]+0.234685, log = FALSE)+dnorm(histograma$breaks,0,0.5),col="blue",lty=2,lwd=2)


histograma<-hist(C.OD[as.numeric(x)==2],freq=F)
lines(density(C.OD[as.numeric(x)==2]),lty=3,lwd=2)
lines(dpois(histograma$breaks, 0.6931, log = FALSE),col="red",lty=2,lwd=2)
lines(dpois(histograma$breaks, 0.6931, log = FALSE)+dnorm(histograma$breaks,0,0.5),col="blue",lty=2,lwd=2)



### 14.1.4. Analysis using WinBUGS
# Define model
sink("overdispersion.txt")
cat("
model {
# Priors
 alpha ~ dnorm(0,0.001)
 beta ~ dnorm(0,0.001)
 sigma ~ dunif(0, 10)	
 tau <- 1 / (sigma * sigma)

# Likelihood
 for (i in 1:n) {
    C.OD[i] ~ dpois(lambda[i]) 
    log(lambda[i]) <- alpha + beta *x[i] + eps[i]
    eps[i] ~ dnorm(0, tau)
 }
}
",fill=TRUE)
sink()

# Bundle data
bugs.data <- list(C.OD = C.OD, x = as.numeric(x)-1, n = length(x))

# Inits function
inits <- function(){ list(alpha=rlnorm(1), beta=rlnorm(1), sigma = rlnorm(1))}

# Parameters to estimate
params <- c("lambda","alpha", "beta", "sigma")

# MCMC settings
nc <- 3		# Number of chains
ni <- 3000		# Number of draws from posterior per chain
nb <- 1000		# Number of draws to discard as burn-in
nt <- 5		# Thinning rate

# Start Gibbs sampling
library(R2OpenBUGS)
out <- bugs(data=bugs.data, inits=inits, parameters.to.save=params,model.file="overdispersion.txt", n.thin=nt,
            n.chains=nc,n.burnin=nb, n.iter=ni)
print(out, dig = 3)
